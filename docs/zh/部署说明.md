# 部署说明

本文档介绍如何部署 QuickDeck 系统。

## 前置要求

- Docker 和 Docker Compose（推荐版本：Docker 20.10+，Docker Compose 2.0+）
- 至少 2GB 可用内存
- 至少 10GB 可用磁盘空间

## 快速部署（Docker Compose）

### 1. 克隆项目

```bash
git clone <repository-url>
cd quickdeck
```

### 2. 配置环境变量

#### 后端环境变量

```bash
cp env.example backend/.env
```

编辑 `backend/.env` 文件，配置以下变量：

```env
# 数据库连接（如果使用 Docker Compose，保持默认即可）
DATABASE_URL=postgresql://postgres:postgres@db:5432/quickdeck

# 安全密钥（请修改为随机字符串）
SECRET_KEY=your-secret-key-here-change-this

# JWT 算法
ALGORITHM=HS256

# Token 过期时间（分钟）
ACCESS_TOKEN_EXPIRE_MINUTES=43200
```

#### 前端环境变量

```bash
cp env.example frontend/.env.local
```

编辑 `frontend/.env.local` 文件，配置以下变量：

```env
# 环境模式
NODE_ENV=production

# 前端访问地址（根据实际情况修改）
NEXT_PUBLIC_URL=http://localhost

# NextAuth 密钥（请修改为随机字符串）
NEXTAUTH_SECRET=your-secret-key-here-change-this
```

### 3. 启动服务

```bash
# 使用 Makefile（推荐）
make dev

# 或直接使用 docker-compose
docker-compose up --build -d
```

### 4. 初始化数据库

等待所有服务启动后，执行数据库迁移：

```bash
# 使用 Makefile
make migrate-upgrade

# 或手动执行
docker exec -it quickdeck-backend poetry run alembic upgrade head
```

### 5. 创建管理员账号

```bash
# 进入后端容器
docker exec -it quickdeck-backend bash

# 运行初始化脚本（如果有）
# 或通过 API 创建用户
```

### 6. 访问应用

- **前端界面**：http://localhost
- **后端 API**：http://localhost:8000
- **API 文档**：http://localhost:8000/docs

## 生产环境部署

### 1. 配置生产环境变量

#### 后端环境变量（`backend/.env`）

```env
# 生产环境数据库连接
DATABASE_URL=postgresql://user:password@db-host:5432/quickdeck

# 强随机密钥（使用 openssl 生成）
SECRET_KEY=$(openssl rand -hex 32)

ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=43200
```

#### 前端环境变量（`frontend/.env.local`）

```env
NODE_ENV=production

# 生产环境前端地址
NEXT_PUBLIC_URL=https://yourdomain.com

# 强随机密钥
NEXTAUTH_SECRET=$(openssl rand -hex 32)
```

### 2. 构建 Docker 镜像

```bash
# 使用 Makefile
make docker-build REGISTRY=your-registry TAG=latest

# 或手动构建
docker build -t your-registry/quickdeck-backend:latest -f backend/Dockerfile backend/
docker build -t your-registry/quickdeck-frontend:latest -f frontend/Dockerfile frontend/
```

### 3. 修改 docker-compose.yml

如果使用私有镜像仓库，需要修改 `docker-compose.yml` 中的镜像名称。

### 4. 启动服务

```bash
docker-compose up -d
```

### 5. 初始化数据库

```bash
make migrate-upgrade
```

### 6. 配置反向代理（可选）

如果需要使用域名访问，可以配置 Nginx 反向代理：

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 本地开发部署

### 模式 1：混合开发模式（推荐）

数据库和 Nginx 在 Docker 容器中运行，后端和前端在本地运行。

#### 1. 安装依赖

```bash
make install
```

#### 2. 配置环境变量

参考"快速部署"章节配置环境变量。

#### 3. 启动基础服务

```bash
make dev-base
```

#### 4. 运行数据库迁移

```bash
make migrate-upgrade
```

#### 5. 启动后端服务（新终端）

```bash
make dev-backend
```

#### 6. 启动前端服务（新终端）

```bash
make dev-frontend
```

访问地址：
- 前端：http://localhost（通过 Nginx 代理）
- 后端 API：http://localhost:8000（直接访问）或 http://localhost/api（通过 Nginx 代理）
- API 文档：http://localhost:8000/docs

### 模式 2：完全本地开发

所有服务都在本地运行。

#### 1. 安装依赖

```bash
make install
```

#### 2. 启动本地 PostgreSQL

```bash
docker run -d --name quickdeck-db \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=quickdeck \
  -p 5432:5432 \
  postgres:16-alpine
```

#### 3. 配置环境变量

修改 `backend/.env` 中的 `DATABASE_URL`：

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/quickdeck
```

#### 4. 运行数据库迁移

```bash
make migrate-upgrade
```

#### 5. 启动后端服务

```bash
cd backend
poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 6. 启动前端服务（新终端）

```bash
cd frontend
npm run dev
```

访问地址：
- 前端：http://localhost:3000
- 后端 API：http://localhost:8000
- API 文档：http://localhost:8000/docs

## 服务管理

### 查看服务状态

```bash
docker-compose ps
```

### 查看服务日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f frontend
docker-compose logs -f backend
docker-compose logs -f nginx
docker-compose logs -f db
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart frontend
docker-compose restart backend
```

### 停止服务

```bash
docker-compose down
```

### 停止并清理数据

```bash
docker-compose down -v
```

## 数据库管理

### 备份数据库

```bash
docker exec quickdeck-db pg_dump -U postgres quickdeck > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 恢复数据库

```bash
docker exec -i quickdeck-db psql -U postgres quickdeck < backup_file.sql
```

### 进入数据库

```bash
docker exec -it quickdeck-db psql -U postgres -d quickdeck
```

## 故障排查

### 服务无法启动

1. 检查端口是否被占用：
   ```bash
   netstat -tulpn | grep 8000
   netstat -tulpn | grep 3000
   netstat -tulpn | grep 5432
   ```

2. 查看服务日志：
   ```bash
   docker-compose logs -f
   ```

3. 检查环境变量配置是否正确

### 数据库连接失败

1. 检查数据库容器是否运行：
   ```bash
   docker-compose ps db
   ```

2. 检查数据库连接配置：
   ```bash
   cat backend/.env | grep DATABASE_URL
   ```

3. 测试数据库连接：
   ```bash
   docker exec -it quickdeck-db psql -U postgres -d quickdeck -c "SELECT 1;"
   ```

### 前端无法访问后端 API

1. 检查后端服务是否运行：
   ```bash
   docker-compose ps backend
   ```

2. 检查 Nginx 配置：
   ```bash
   docker-compose logs nginx
   ```

3. 检查前端环境变量中的 `NEXT_PUBLIC_URL` 配置

## 安全建议

1. **修改默认密钥**：确保 `SECRET_KEY` 和 `NEXTAUTH_SECRET` 使用强随机字符串
2. **使用 HTTPS**：生产环境建议配置 HTTPS
3. **数据库密码**：使用强密码保护数据库
4. **防火墙**：限制数据库端口的外部访问
5. **定期备份**：定期备份数据库和重要配置

## 更新部署

### 更新代码

```bash
# 拉取最新代码
git pull

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### 更新数据库结构

```bash
# 运行数据库迁移
make migrate-upgrade
```

## 性能优化

1. **数据库连接池**：根据实际负载调整数据库连接池大小
2. **缓存**：考虑添加 Redis 缓存层
3. **负载均衡**：高并发场景下使用负载均衡器
4. **资源限制**：为 Docker 容器设置合理的资源限制

---

如有问题，请参考 [常见问题](./常见问题.md) 或提交 Issue。

